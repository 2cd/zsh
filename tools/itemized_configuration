#!/usr/bin/env bash
##################
change_the_terminal_color_scheme() {
    case "${LINUX_DISTRO}" in
    Android) bash ${TMOE_ZSH_TERMUX_PATH}/colors.sh ;;
    *)
        printf '%s\n' 'éå¸¸æŠ±æ­‰ï¼Œæ­¤åŠŸèƒ½åªæ”¯æŒå®‰å“'
        printf "%s\n" "Sorry, this feature only supports Android"
        press_enter_to_return
        zsh_itemized_configuration_menu
        ;;
    esac
}
###############
change_the_terminal_font() {
    case "${LINUX_DISTRO}" in
    Android) bash ${TMOE_ZSH_TERMUX_PATH}/fonts.sh ;;
    *)
        #printf '%s\n' 'éå¸¸æŠ±æ­‰ï¼Œæ­¤åŠŸèƒ½åªæ”¯æŒå®‰å“'
        #printf "%s\n" "Sorry, this feature only supports Android"
        #press_enter_to_return
        #zsh_itemized_configuration_menu
        LOCAL_FONT_DIR="/usr/local/share/fonts/truetype/powerline"
        printf "%s\n" "${LOCAL_FONT_DIR}/fonts"
        if [ -e "${LOCAL_FONT_DIR}/fonts/Iosevka/Iosevka.ttf" ]; then
            su - ${CURRENT_USER_NAME} -c "xdg-open ${LOCAL_FONT_DIR}/fontfs"
        else
            mkdir -p ${LOCAL_FONT_DIR}
            git clone --depth=1 https://gitee.com/ak2/termux-fonts.git ${LOCAL_FONT_DIR}
            cd ${LOCAL_FONT_DIR}
            tar -Jxvf fonts.tar.xz
            rm -rvf .git fonts.tar.xz
            mkfontscale 2>/dev/null
            mkfontdir 2>/dev/null
            fc-cache 2>/dev/null
            su - ${CURRENT_USER_NAME} -c "xdg-open ${LOCAL_FONT_DIR}/fontfs"
        fi
        ;;
    esac
}
################
edit_zshrc_manually() {
    if [ $(command -v editor) ]; then
        editor ${HOME}/.zshrc
    elif [ $(command -v vim) ]; then
        vim ${HOME}/.zshrc
    elif [ $(command -v nano) ]; then
        nano ${HOME}/.zshrc
    else
        vi ${HOME}/.zshrc
    fi
}
###########
zsh_itemized_configuration_menu() {
    RETURN_TO_WHERE='zsh_itemized_configuration_menu'
    #17 50 5
    #zshä¸»é¢˜å…¨å¹³å°é€šç”¨,Termuxé…è‰²å’Œå­—ä½“ä»…é€‚ç”¨Android Termux,xfce4ç»ˆç«¯é…è‰²ä»…é€‚ç”¨äºlinuxã€‚You can use zsh theme on all platforms,but termux colors and fonts are only available for Android.
    TMOE_OPTION=$(whiptail --title "Itemized Configuration" --menu "æ‚¨æƒ³è¦é…ç½®å“ªä¸ªé¡¹ç›®?\nWhich configuration do you want to modify?" 0 0 0 \
        "1" "edit .zshrcæ‰‹åŠ¨ç¼–è¾‘é…ç½®" \
        "2" "zshä¸»é¢˜ themes" \
        "3" "Termuxé…è‰² color schemes" \
        "4" "ç»ˆç«¯å­—ä½“ fonts" \
        "5" "xfce4ç»ˆç«¯é…è‰² xfce4-terminal color schemes" \
        "6" "Set zsh as the default(é»˜è®¤) shell" \
        "0" "ğŸŒš Back to the main menu è¿”å›ä¸»èœå•" \
        3>&1 1>&2 2>&3)
    ###########
    case "${TMOE_OPTION}" in
    0 | "") tmoe_zsh_main_menu ;;
    1) edit_zshrc_manually ;;
    2) bash ${TMOE_ZSH_TERMUX_PATH}/themes.sh ;;
    3) change_the_terminal_color_scheme ;;
    4) change_the_terminal_font ;;
    5) configure_xfce_terminal_color ;;
    6) configure_default_shell ;;
    esac
    ##############################
    press_enter_to_return
    ${RETURN_TO_WHERE}
}
############################
download_iosevka_font() {
    wget -qO 'Iosevka.tar.xz' 'https://gitee.com/mo2/Termux-zsh/raw/p10k/Iosevka.tar.xz'
    tar -xvf 'Iosevka.tar.xz'
    rm -f 'Iosevka.tar.xz'
    mv -f font.ttf '/usr/share/fonts/truetype/iosevka/Iosevka.ttf'
}
###############
configure_xfce_terminal_color() {
    case "${LINUX_DISTRO}" in
    Android)
        printf '%s\n' 'Sorryï¼Œæ­¤åŠŸèƒ½ä¸æ”¯æŒAndroid'
        press_enter_to_return
        zsh_itemized_configuration_menu
        ;;
    esac
    if [ ! -d "/usr/share/xfce4/terminal" ]; then
        printf "%s\n" "æ£€æµ‹åˆ°xfceç»ˆç«¯ç›®å½•ä¸å­˜åœ¨ï¼Œæ‚¨å½“å‰å¯èƒ½æ²¡æœ‰å®‰è£…xfceç»ˆç«¯"
        do_you_want_to_continue
        #printf '%s\n'  'Press Ctrl+C to cancel.'
        #press_enter_to_continue
        mkdir -p /usr/share/xfce4/terminal
        ${TMOE_INSTALLATON_COMMAND} xfce4-terminal || sudo ${TMOE_INSTALLATON_COMMAND} xfce4-terminal
    fi

    cd /usr/share/xfce4/terminal
    printf "%s\n" "/usr/share/xfce4/terminal"
    printf "%s\n" "æ­£åœ¨é…ç½®xfce4ç»ˆç«¯é…è‰²..."
    sudo wget -qO "colorschemes.tar.xz" 'https://gitee.com/mo2/xfce-themes/raw/terminal/colorschemes.tar.xz'
    sudo tar -Jxvf "colorschemes.tar.xz"
    DEPENDENCIES=""
    if [ ! -e /usr/bin/mkfontscale ]; then
        DEPENDENCIES="${DEPENDENCIES} xfonts-utils"
    fi

    if [ ! -e /usr/bin/fc-cache ]; then
        DEPENDENCIES="${DEPENDENCIES} fontconfig"
    fi
    if [ ! -z "$DEPENDENCIES" ]; then
        printf "%s\n" "æ­£åœ¨å®‰è£…ç›¸å…³ä¾èµ–..."
        case $(id -u) in
        0)
            ${TMOE_UPDATE_COMMAND}
            ${TMOE_INSTALLATON_COMMAND} ${DEPENDENCIES}
            ;;
        *)
            sudo ${TMOE_UPDATE_COMMAND}
            sudo ${TMOE_INSTALLATON_COMMAND} ${DEPENDENCIES}
            ;;
        esac
    fi
    if [ ! -f '/usr/share/fonts/truetype/iosevka/Iosevka.ttf' ]; then
        printf '%s\n' 'æ­£åœ¨åˆ·æ–°å­—ä½“ç¼“å­˜...'
        mkdir -p /usr/share/fonts/truetype/iosevka/
        cd /tmp
        if [ -e "font.ttf" ]; then
            mv -f font.ttf '/usr/share/fonts/truetype/iosevka/Iosevka.ttf'
        else
            download_iosevka_font
        fi
        cd /usr/share/fonts/truetype/iosevka/
        mkfontscale
        mkfontdir
        fc-cache
    fi
}
########################################################
android_default_shell() {
    if (whiptail --title "android_default_shell" --yes-button 'Yes' --no-button 'no' --yesno 'Androidåœ¨é…ç½®æœ¬å·¥å…·æ—¶ï¼Œå·²ç»å°†zshè®¾ç½®ä¸ºé»˜è®¤shelläº†ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨ç»ˆç«¯ä¸‹è¾“chsh -s bashæˆ–chsh -s zshæ¥åˆ‡æ¢é»˜è®¤shell ã€‚æ‚¨æ˜¯å¦éœ€è¦å°†é»˜è®¤shellè®¾ç½®ä¸ºzsh?' 12 50); then
        chsh -s zsh
    else
        ${RETURN_TO_WHERE}
    fi
}
##########
gnu_linux_default_shell() {
    if (whiptail --title "gnu_linux_default_shell" --yes-button 'Yes' --no-button 'no' --yesno 'Linuxåœ¨è®¾ç½®æ—¶éœ€è¦è¾“å¯†ç ,è‹¥éœ€æ‰‹åŠ¨é…ç½®ï¼Œè¯·è¾“chsh -s $(command -v zsh)æˆ–chsh -s /bin/zsh,æ‚¨æ˜¯å¦éœ€è¦å°†é»˜è®¤shellè®¾ç½®ä¸ºzsh?' 10 50); then
        chsh -s $(command -v zsh) || sudo chsh -s $(command -v zsh)
    else
        ${RETURN_TO_WHERE}
    fi
}
#############################################################
configure_default_shell() {
    case "${LINUX_DISTRO}" in
    Android) android_default_shell ;;
    *) gnu_linux_default_shell ;;
    esac
    printf "%s\n" "${YELLOW}å·²å°†é»˜è®¤shellåˆ‡æ¢ä¸ºzsh,æŒ‰å›è½¦é”®è¿”å›ã€‚Press enter to return.${RESET}"
    read
    ${RETURN_TO_WHERE}
}
#####################################################
zsh_itemized_configuration_menu
